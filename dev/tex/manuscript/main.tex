\documentclass[a4paper]{article}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{tikz}
\usetikzlibrary{arrows}
\usepackage{booktabs}
\usepackage{threeparttable}
\usepackage{tikz}
\usetikzlibrary{arrows.meta}
\usepackage{pgfplots}
\usepackage{subcaption}
\usepackage[toc,page]{appendix}
\usepackage{bm}

\title{Fourth order summation-by-parts finite difference methods for  3-D elastic wave propagation in curvilinear coordinates with mesh refinement interfaces}

\date{\today}
\author{ Lu Zhang \and Siyang Wang \and N. Anders Petersson}
\begin{document}
\maketitle

\begin{abstract}
We analyze
\end{abstract}

\section{Introduction}

\section{The isotropic elastic wave equation }
We consider the time dependent isotropic elastic wave equation in three dimensional domain for simple Cartesian domain and the curvilinear domian.
\subsection{The Cartesian coordinates}
The problem is defined on the domain ${\bf x}\in\Omega$ with ${\bf x} = (x_1,x_2,x_3)^T$ are Cartesian coordinates. Denote ${\bf u} = (u_1,u_2,u_3)^T$ to be the three dimensional displacement vector in Cartesian coordinates, then the elastic wave equation takes the form,
\begin{eqnarray*}
    \rho\frac{\partial^2{\bf u}}{\partial^2 t} &=& \nabla\cdot\mathcal{T} + {\bf F}, \ \ \ {\bf x}\in\Omega,\ \ \ t\geq 0,\\
    \nabla\cdot\mathcal{T} &:=& {\bf Lu},
\end{eqnarray*}
provided with appropriate initial and boundary conditions. Here, $\rho$ is density, $\mathcal{T}$ is the stress tensor and ${\bf F}$ is the force function. The spatial operator ${\bf L}$ is called $3\times3$ symmetric Kelvin-Christoffel differential operator matrix, specifically,
\begin{equation*}
    {\bf L u} = \partial_1(A_1\nabla{\bf u}) + \partial_2(A_2\nabla{\bf u}) + \partial_3(A_3\nabla{\bf u}),
\end{equation*}
with
\begin{eqnarray*}
A_1\nabla{\bf u} &:=& M^{11}\partial_1{\bf u} + M^{12}\partial_2{\bf u} + M^{13}\partial_3{\bf u}, \\
A_2\nabla{\bf u} &:=& M^{21}\partial_1{\bf u} + M^{22}\partial_2{\bf u} + M^{23}\partial_3{\bf u}, \\
A_3\nabla{\bf u} &:=& M^{31}\partial_1{\bf u} + M^{32}\partial_2{\bf u} + M^{33}\partial_3{\bf u},
\end{eqnarray*}
where $M^{i,j}, i = 1,2,3, j = 1,2,3$ are defined by
\begin{equation*}
M^{i,j} = P^T_iCP_j.
\end{equation*}
Here, $C$ is symmetric and we refer to Appendix ? for the definitions of matrices $C$ and $P_i, i = 1,2,3$. Especially, for the isotropic elastic wave equation, we have
\[ M^{11} = \left(\begin{array}{ccc}
2\mu+\lambda & 0 & 0\\
0 & \mu & 0\\
0 & 0 & \mu\end{array}\right), M^{12} = \left(\begin{array}{ccc}
0 & \lambda & 0\\
\mu & 0 & 0\\
0 & 0 & 0\end{array}\right), M^{13} = \left(\begin{array}{ccc}
0 & 0 & \lambda\\
0 & 0 & 0\\
\mu & 0 & 0\end{array}\right),\]
\[ M^{21} =(M^{12})^T, M^{22} = \left(\begin{array}{ccc}
\mu & 0 & 0\\
0 & 2\mu+\lambda & 0\\
0 & 0 & \mu\end{array}\right), M^{23} = \left(\begin{array}{ccc}
0 & 0 & 0\\
0 & 0 & \lambda\\
0 & \mu & 0\end{array}\right),\]
\[ M^{31} = (M^{13})^T, \ \ \ \ \ M^{32} =(M^{23})^T, \ \ \ \ \ M^{33} = \left(\begin{array}{ccc}
\mu & 0 & \lambda\\
0 & \mu & 0\\
0 & 0 & 2\mu+\lambda\end{array}\right),\]
Here, $\lambda$ and $\mu$ are the first and second Lame parameters respectively, which are determined by the properties of the material.

Denote the outward unit normal ${\bf n} = (n^{(1)},n^{(2)},n^{(3)})$, then we have the boundary traction data 
\begin{equation*}
{\bf n}\cdot\mathcal{T} = n^{(1)}A_1\nabla{\bf u} + n^{(2)}A_2\nabla{\bf u} + n^{(3)}A_3\nabla{\bf u}. 
\end{equation*}
A homogeneous Dirichlet boundary condition corresponds to ${\bf u} = {\bf 0}$ and a free surface boundary condtion is ${\bf n}\cdot\mathcal{T}  = {\bf 0}$.

It is known that the elastic wave equation with the homogeneous Dirichelet boundary conidtion or free surface boundary condition is a well-posed problem and the total energy of the solution is conserved if the external force function ${\bf F} = 0$ \cite{?}.

\subsection{Generalization to curvilinear coordinates}
%Present the transformed equation. Notation is important. We can write a few formulas first, and discuss if it is good notation. Maybe we shall follow notations from one of Anders' papers?

In this section, we consider a curvilinear domain. Assume there is a one-to-one mapping ${\bf x} = {\bf x}({\bf r}) : [0,1]^3 \rightarrow \Omega \in \mathcal{R}^3$ with ${\bf x}({\bf r}) = (x^{(1)}({\bf r}),x^{(2)}({\bf r}),x^{(3)}({\bf r}))^T, {\bf r} = (r^{(1)},r^{(2)},r^{(3)})^T, 0\leq r^{(i)}\leq1, i = 1,2,3$.

We define the derivative of the forward mapping to be 
\begin{equation*}
{\bf a}_k := \bar{\partial}_k{\bf x} = \left(\frac{\partial x^{(1)}}{\partial r^{(k)}},\frac{\partial x^{(2)}}{\partial r^{(k)}},\frac{\partial x^{(3)}}{\partial r^{(k)}}\right)^T,
\end{equation*}
for $k = 1,2,3$ and the backward mapping to be
\begin{equation*}
{\bf a}^k := \nabla r^{(k)} = \left(\frac{\partial r^{(k)}}{\partial x^{(1)}},\frac{\partial r^{(k)}}{\partial x^{(2)}},\frac{\partial r^{(k)}}{\partial x^{(3)}}\right)^T := (\xi_{1k},\xi_{2k},\xi_{3k})^T,
\end{equation*}
for $k = 1,2,3$. It is known that the backward mapping can be expressed by the forward mapping \cite{?}, 
\begin{equation*}
{\bf a}^i = \frac{1}{J}({\bf a}_j\times{\bf a}_k), \ \ \ (i,j,k) \ \text{cycle},
\end{equation*}
here, $J$ is the Jacobian of the forward mapping $J = \text{det}({\bf a}_1, {\bf a}_2, {\bf a}_3)$ and the mapping is assumed to be non-singular with $0<J<\infty$.

After applying the forward and backward mapping, reader can refer to \cite{?} for details, the elastic wave equation can be written as
\begin{equation*}
\rho\frac{\partial^2 {\bf u}}{\partial t^2} = \frac{1}{J}\left[\tilde{\partial }_1(\tilde{A}_1\tilde{\nabla}{\bf u}) + \tilde{\partial }_2(\tilde{A}_2\tilde{\nabla}{\bf u}) +\tilde{\partial }_3(\tilde{A}_3\tilde{\nabla}{\bf u}) \right] + {\bf F},
\end{equation*}
where
\begin{align*}
	\bar{A}_1\tilde{\nabla}{\bf u} &:= N_{11}\bar{\partial}_1{\bf u} + N_{12}\bar{\partial}_2{\bf u} + N_{13}\bar{\partial}_3{\bf u}, \\
	\bar{A}_2\tilde{\nabla}{\bf u} &:= N_{21}\bar{\partial}_1{\bf u} + N_{22}\bar{\partial}_2{\bf u} + N_{23}\bar{\partial}_3{\bf u}, \\
	\bar{A}_3\tilde{\nabla}{\bf u} &:= N_{31}\bar{\partial}_1{\bf u} + N_{32}\bar{\partial}_2{\bf u} + N_{33}\bar{\partial}_3{\bf u},
\end{align*}
here, $N_{ij} = J\bar{P}_i^TC\bar{P}_j$ with $\bar{P}_i = \sum_{j=1}^3\xi_{ji}P_j$. The matrices $C$ and $P_i, i = 1,2,3$ can be found in Appendix ?. 

The transformation of homogeneous Dirichlet boundary condiiton to curvilinear coordinates is straightfroward, ${\bf u}({\bf x}) = {\bf u}(\bf r)$. To transfer the free surface boundary condition to curvilinear coordinates, we firstly write the unit outside normal to be the function of metric derivatives, for example, along the boundary $r^{(3)} = 1$ or $r^{(3)} = 0$,
\begin{equation*}
{\bf n} := (n^{(1)},n^{(2)},n^{(3)})^T = \pm \frac{\nabla r^{(3)}}{\left|\nabla r^{(3)}\right|} = \frac{\pm 1}{\sqrt{((\xi_{13})^2+(\xi_{23})^2+(\xi_{33})^2)}}\left(\xi_{13},\xi_{23},\xi_{33}\right)^T,
\end{equation*}
here, $'+'$ corresponds to $r^{(3)} = 1$ and $'-'$ corresponds to $r^{(3)} = 0$. Then after some straightforward calculation, the traction free boundary condition can be written as
\begin{equation*}
\mathcal{T}\cdot{\bf n} = \frac{\pm 1}{J\left|\nabla r^{(3)}\right|}\bar{A}_3\bar{\nabla}{\bf u}, \ \ \ r^{(3)} = 0, 1.
\end{equation*}
Similarly, we can derive the traction free boundary condition along $r^{(1)} = 0,1$ and $r^{(2)} = 0,1$ as
\begin{align*}
\mathcal{T}\cdot{\bf n} &= \frac{\pm 1}{J\left|\nabla r^{(1)}\right|}\bar{A}_1\bar{\nabla}{\bf u}, \ \ \ r^{(1)} = 0, 1,\\
\mathcal{T}\cdot{\bf n} &= \frac{\pm 1}{J\left|\nabla r^{(2)}\right|}\bar{A}_2\bar{\nabla}{\bf u}, \ \ \ r^{(2)} = 0, 1,
\end{align*} 
respectively.

\subsubsection{Energy estimate}

From the definition of matrcies $N_{ij}$, we can easily verify that $N_{11}, N_{22}, N_{33}$ are positive definite and $N_{ij} = N_{jk}^T$.

refer to the Cartesian case, give the proof for the energy estimate for curvilinear case (need to be completed)

\section{The spatial discretization}
%We present the SBP operators, the semi-discrete equation, and the discretized boundary conditions and interface conditions. Also a semi-discrete energy estimate (if we do not write a fully discrete energy estimate).

In this section, we only describe the discretization for the curvilinear domain, and the Catesian domain can be obtained by simply setting the Cartesian coordinates as $x^{(k)}(r^{(k)}) = a^{(k)}r^{(k)} $ with $a^{(k)}$ being constants.
\subsection{SBP operators in $1$D}
Consider a uniform discretization on the domain $x\in[0,1]$ with the grids,
\[\tilde{{\bf x}} = [x_0,x_1,\cdots,x_n,x_{n+1}]^T,\ \  x_i = (i-1)h,\ \ i = 0,1,\cdots,n,n+1,\ \ h = 1/n,\]
where $i = 1,n$ are boundary grids and $i = 0,n+1$ are ghost points, the grids which don't contain the ghost points are denoted as ${\bf x} = [x_1,x_2,\cdots,x_n]^T$. We adopt the same fasion as in \cite{?}, the tilde symbol indicates the ghost points are considered in the rest of paper. The first derivative operator $D \approx \frac{\partial }{\partial x}$ is a first order derivative SBP operator if 
\begin{equation}\label{first_sbp}
({\bf u}, D{\bf v})_h = -(D{\bf u},{\bf v})_h - u_1v_1 + u_nv_n,
\end{equation}
with a scalar product
\begin{equation}\label{inner_product}
({\bf u},{\bf v})_h = h\sum_{i = 1}^{n}\omega_iu_iv_i.
\end{equation}
Here, $0<\omega_i < \infty $ are the weights of scalar product. The first order difference operator is a centered difference  operator when the grid points are far from the boudnary and the corresponding weight $\omega_i = 1$. To satify the SBP identity (\ref{first_sbp}), the coefficients in the D need to be modified for the points near the boundary and the corresponding weights $\omega_i \neq 1$.

In the elastic wave equation, the second derivative term $(\gamma(x)u_x)_x$ appears. Here, the known function $\gamma(x)$ describes the property of the material. There are two different fourth order accuracy SBP operators used to approximate $(\gamma(x)u_x)_x$. One is derived by Sjo\"green and Petersson \cite{?}, they used the ghost points to approximate the second derivative, $ (\gamma(x)u_x)_x \approx \tilde{G}(\gamma)\tilde{\bf u}$. $\tilde{G}(\gamma)$ is a second derivative SBP operator satisfies,
\begin{equation}\label{sbp_2nd_1}
({\bf u}, \tilde{G}(\gamma)\tilde{\bf v})_h = -S_\gamma({\bf u},{\bf v})-u_1\gamma_1\tilde{\bf b}_1\tilde{\bf v} + u_n\gamma_n\tilde{\bf b}_n^T\tilde{\bf v}.
\end{equation}
Here, $S_\gamma(\cdot,\cdot)$ is a stmmetric and positive semi-definite bilinear form, $\tilde{\bf b}_1$ and $\tilde{\bf b}_n$ are difference operator aprroximated the first derivative on the left and right boundaries, respectively. We use the left boundary as an example here, $\tilde{\bf b}_1 \tilde{\bf v} = \frac{1}{h}\sum_{i=0}^{\tilde{m}} \tilde{d}_iv_i$, $\tilde{m}$ is determined by the order of the method and $\tilde{d}_i$ are the constant stencil coefficients. The other is developed by Mattsson \cite{?}, the second derivative $(\gamma(x)u_x)_x$ is approximated by $G(\gamma){\bf u}$ without ghost points,
\begin{equation}\label{sbp_2nd_2}
({\bf u}, G(\gamma){\bf v})_h = -S_\gamma({\bf u},{\bf v})-u_1\gamma_1{\bf b}_1{\bf v} + u_n\gamma_n{\bf b}_n^T{\bf v}.
\end{equation}
Here, ${\bf b}_1$ and ${\bf b}_n$ are also finite difference operator for first order derivative, but wiout ghost points, ${\bf b}_1 {\bf v} = \frac{1}{h}\sum_{i=1}^{m} d_i v_i$. 

For the second derivative SBP operator $\tilde{G}(\gamma)\tilde {\bf u}$ and $G(\gamma){\bf u}$, both of them use a fourth order five points centered difference stencil to approximate $(\gamma u_x)_x$ for the interior points which are away from the boundaries points. For the first and the last six points which are close to the boudaries, the operators $G(\gamma){\bf u}$ and $\tilde{G}(\gamma)\tilde{\bf{u}}$ use second order accurate one-sides difference stencil. They are designed to satisfy (\ref{sbp_2nd_2}) and (\ref{sbp_2nd_1}) respectively. For stucture and the form of the operators $\tilde{G}(\gamma)\tilde {\bf u}$ and $G(\gamma){\bf u}$, we refer the readers \cite{???} for detailed information.

\subsection{Semi-discretization of the elastic wave equation}
We consider the elastic wave equation in curvilinear coordinates 
\[\rho\frac{\partial^2 {\bf u}}{\partial t^2} = L{\bf u},\]
where
\begin{multline}\label{spatial_operator}
L{\bf u} = \frac{1}{J}\Big[\bar{\partial}_1(N^{11}\bar{\partial}_1{\bf u}) + \bar{\partial}_2(N^{22}\bar{\partial}_2{\bf u}) + \bar{\partial}_3(N^{33}\bar{\partial}_3{\bf u}) + \bar{\partial}_1(N^{12}\bar{\partial}_2{\bf u}) + \bar{\partial}_1(N^{13}\bar{\partial}_3{\bf u}) \\
+ \bar{\partial}_2(N^{21}\bar{\partial}_1{\bf u}) + \bar{\partial}_2(N^{23}\bar{\partial}_3{\bf u}) +\bar{\partial}_3(N^{31}\bar{\partial}_1{\bf u}) + \bar{\partial}_3(N^{32}\bar{\partial}_2{\bf u})\Big].
\end{multline}
The parameter space $[0,1]\times[0,1]\times[0,1]$ is discretized as $r_i^{(1)} = (i-1)h_1, i = 0,1,2,\cdots,n_1+1$, $r_i^{(2)} = (i-1)h_2, i = 0,1,2,\cdots,n_2+1$, and $r_i^{(3)} = (i-1)h_3, i = 0,1,2,\cdots,n_3+1$ with $h_1 = 1/(n_1-1), h_2 = 1/(n_2-1), h_3 = 1/(n_3-1)$, the ghost points are used to impose the boundary conditions and interface conditions.

The terms $\bar{\partial}_i(N^{ii}\bar{\partial}_i{\bf u}), i = 1,2,3$ in the spatial operator (\ref{spatial_operator}) are approximated by a fourth order second derivative SBP4 operator. The operators $D_i$ are used to approximate the $\bar{\partial}_i, i = 1,2,3$. The terms $\bar{\partial}_i(N^{ij}\bar{\partial}_j{\bf u}), i = 1,2,3, j = 1,2,3$ are approximated by using the first derivative operatoe $D$ twice. Then the spatial operator (\ref{spatial_operator}) is discretizes as
\begin{multline}
L_h{\bf u}_{i,j,k} = \frac{1}{J_{i,j,k}}\big[G_1(N_{11}){\bf u}_{i,j,k}+G_2(N_{22}){\bf u}_{i,j,k}+\tilde{G}_3(N_{33}){\bf u}_{i,j,k}+D_1(N_{12}D_2{\bf u}_{i,j,k})\\
+D_1(N_{13}D_3{\bf u}_{i,j,k})+D_2(N_{21}D_1{\bf u}_{i,j,k})+D_2(N_{23}D_3{\bf u}_{i,j,k})+D_3(N_{31}D_1{\bf u}_{i,j,k})\\
+D_3(N_{32}D_2{\bf u}_{i,j,k})\big],
\end{multline}
for $i = 1,2,\cdots,n_1$, $j = 1,2,\cdots,n_2$ and $k = 1,2,\cdots,n_3$.
 
\subsection{Physical boundary conditions}
We consier both homegeneous Dirichlet boundary condition and free surface bounary condition.

\section{Grid refinement interface}
In this section, we partitioning the physical domian into two subdomains such that the discontinuity is aligned with subdomian boundary $\Gamma$,
\begin{align}\label{fine_coarse_problem}
\rho^c\frac{\partial ^2 {\bf u}^c}{\partial t^2} &= L{\bf u}^c, \ \ \ \ \ {\bf x} \in \Omega_c,\ \ \ t>0 \nonumber\\
\rho^f\frac{\partial ^2 {\bf u}^f}{\partial t^2} &= L{\bf u}^f, \ \ \ \ \ {\bf x} \in \Omega_f,\ \ \ t>0
\end{align}
provided suitable initial and boundary conditions and $\Omega_c\cup\Omega_f = \Omega, \Omega_c\cap\Omega_f = \Gamma$. The interface conditions are given to guarantee the continuity of the solution and the continuity of the traction force,
\begin{align*}
{\bf u}_f &= {\bf u}_c, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ {\bf x}\in \Gamma, \ \ \ t>0, \\
\mathcal{T}^f\cdot{\bf n}^f &= -\mathcal{T}^c\cdot{\bf n}^c,  \ \ \ \ \ \ \ \ \ {\bf x}\in \Gamma, \ \ \ t>0.
\end{align*}

\subsection{The fourth order SBP-GP method }
We approximate the (\ref{fine_coarse_problem}) by
\begin{multline}\label{coarse_scheme}
\rho_{i,j,k}^c ({\bf u}_{tt}^c)_{i,j,k} = \frac{1}{J_{i,j,k}^c}\big[G_1^c(N_{11}^c){\bf u}_{i,j,k}^c+G_2^c(N_{22}^c){\bf u}_{i,j,k}^c+\tilde{G}_3^c(N_{33}^c){\bf u}_{i,j,k}^c\\
+D_1^c(N_{12}^cD_2^c{\bf u}_{i,j,k}^c)+D_1^c(N_{13}^cD_3^c{\bf u}_{i,j,k}^c)+D_2^c(N_{21}^cD_1^c{\bf u}_{i,j,k}^c)+D_2^c(N_{23}^cD_3^c{\bf u}_{i,j,k}^c)\\
+D_3^c(N_{31}^cD_1^c{\bf u}_{i,j,k}^c)+D_3^c(N_{32}^cD_2^c{\bf u}_{i,j,k}^c)\big] := \tilde{B}_c(\mu,\lambda) \bf{u}^c,
\end{multline}
for $ i = 1,2,\cdots,n_1^c, j = 1,2,\cdots,n_2^c, k = 1,2,\cdots,n_3^c$ , and 
\begin{multline}\label{fine_scheme_2}
\rho_{i,j,k}^f ({\bf u}_{tt}^f)_{i,j,k} =
 \frac{1}{J_{i,j,k}^f}\big[G_1^f(N_{11}^f){\bf u}_{i,j,k}^f+G_2^f(N_{22}^f){\bf u}_{i,j,k}^f+G_3^f(N_{33}^f){\bf u}_{i,j,k}^f\\
+D_1^f(N_{12}^fD_2^f{\bf u}_{i,j,k}^f)+D_1^f(N_{13}^fD_3^f{\bf u}_{i,j,k}^f)
+D_2^f(N_{21}^fD_1^f{\bf u}_{i,j,k}^f)+D_2^f(N_{23}^fD_3^f{\bf u}_{i,j,k}^f)\\
+D_3^f(N_{31}^fD_1^f{\bf u}_{i,j,k}^f)
+D_3^f(N_{32}^fD_2^f{\bf u}_{i,j,k}^f)\big],
\end{multline}
for $ i = 1,2,\cdots,n_1^f, j = 1,2,\cdots,n_2^f, k = 2,\cdots,n_3^f$ and
\begin{multline}\label{fine_scheme_1}
\rho_{i,j,k}^f ({\bf u}_{tt}^f)_{i,j,1} = \frac{1}{J_{i,j,1}^f}\big[G_1^f(N_{11}^f){\bf u}_{i,j,1}^f+G_2^f(N_{22}^f){\bf u}_{i,j,1}^f+G_3^f(N_{33}^f){\bf u}_{i,j,1}^f\\
+D_1^f(N_{12}^fD_2^f{\bf u}_{i,j,1}^f)+D_1^f(N_{13}^fD_3^f{\bf u}_{i,j,1}^f)+D_2^f(N_{21}^fD_1^f{\bf u}_{i,j,1}^f)+D_2^f(N_{23}^fD_3^f{\bf u}_{i,j,1}^f)\\
+D_3^f(N_{31}^fD_1^f{\bf u}_{i,j,1}^f)+D_3^f(N_{32}^fD_2^f{\bf u}_{i,j,1}^f)+{\bm \eta}_{i,j}\big] := B_f(\mu,\lambda){\bf u}^f\big|_\Gamma+\frac{{\bm \eta}_{i,j}}{J^f_{i,j,1}},
\end{multline}
for $ i = 1,2,\cdots,n_1^f, j = 1,2,\cdots,n_2^f$, and
\begin{equation*}
{\bm \eta} = \rho^f\big|_\Gamma\mathcal{P}\Big((\rho^c)^{-1}\tilde{B}_c(\mu,\lambda)\tilde{\bf u}^c\big|_\Gamma\Big)-B_f(\mu,\lambda){\bf u}^f\big|_\Gamma,
\end{equation*}
For the grids in the $\Omega^f$  that are on the interface $\Gamma$, we impose the continuity of the solution,
\begin{equation*}
{\bf u}_{i,j,1}^f = \mathcal{P}\big({\bf u}_{i,j,n_3^c}^c\big),
\end{equation*}
as for the ghost points which is on the direction 3 for the coarse domian, we impose the continuity of the flux,
\begin{equation*}
{\bf n}^c\cdot\mathcal{T}^c \big|_\Gamma = \mathcal{R}\left(-{\bf n}^f\cdot\mathcal{T}^f\big|_\Gamma - \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f\big|\nabla r_f^{(3)}\big|}\Big|_\Gamma\right).
\end{equation*}

\subsection{Energy estimate}
%We derive an energy estimate, which tells us what interface conditions we shall impose. Also discuss boundary conditions. Be careful with the Jacobian.

%These two sections should not be too long. We shall cite previous works by Petersson and Sjögreen, and also Duru and Virta 2014. 

Define the scalar product 
\begin{equation*}
({\bf u}, {\bf v})_h = h_1h_2h_3\sum_{i=1}^{n_1}\sum_{j=1}^{n_2}\sum_{k=1}^{n_3}\omega_i^{(1)}\omega_j^{(2)}\omega_k^{(3)}J_{i,j,k}{\bf u}^{T}_{i,j,k}{\bf v}_{i,j,k},
\end{equation*}
and the scalar product on the interface $\Gamma$,
\begin{equation*}
({\bf u}, {\bf v})_{h,\Gamma} = h_1h_2\sum_{i=1}^{n_1}\sum_{j=1}^{n_2}\omega_i^{(1)}\omega_j^{(2)}J_{i,j,k}\big|\nabla r^{3}\big|{\bf u}_{i,j,k}^{T}{\bf v}_{i,j,k},
\end{equation*}
where $k = 1$ for the interface of fine domain and $k = n_3^c$ for the interface of coarse domain.

Multiplying (\ref{coarse_scheme}) by $h_1^ch_2^ch_3^c\omega_i^{(1)}\omega_j^{(2)}\omega_k^{3}J_{i,j,k}^c$ and summing over all grids, we have
\begin{equation}\label{coarse_simple}
({\bf u}_t^c, \rho^c{\bf u}_{tt}^c)_{h^c} = -S_{h^c}({\bf u}_t^c,{\bf u}^c) + B_{h^c}({\bf u}_t^c,{\bf u}^c),
\end{equation}
multiplying (\ref{fine_scheme_1}) by $h_1^fh_2^fh_3^f\omega_i^{(1)}\omega_j^{(2)}\omega_k^{3}J_{i,j,k}^f$ and summing over all grids, we obtain
\begin{multline}\label{fine_simple}
({\bf u}_t^f, \rho^f{\bf u}_{tt}^f)_{h^f} = -S_{h^f}({\bf u}_t^f,{\bf u}^f) + B_{h^f}({\bf u}_t^f,{\bf u}^f) \\
+h_3^f\omega_1^{(3)}h_1^fh_2^f\sum_{i=1}^{n_1^f}\sum_{j=1}^{n_2^f}\omega_i^{(1)}\omega_j^{(2)}({\bf u}_t^f)_{i,j,1}^{T}{\bm \eta}_{i,j},
\end{multline}
where  $S_h$ can be found in Appendix, and 
\begin{multline*}
B_h({\bf u}_t, {\bf u}) = h_2h_3\sum_{j=1}^{n_2}\sum_{k=1}^{n_3}\omega_j^{(2)}\omega_j^{(3)}\big[({\bf u}_t)_{i,j,k}^{T}\bar{A}_1\bar{\nabla}{\bf u}_{i,j,k}\big]_{i=1}^{i=n_1}\\
+h_1h_3\sum_{i=1}^{n_1}\sum_{k=1}^{n_3}\omega_j^{(1)}\omega_j^{(3)}\big[({\bf u}_t)_{i,j,k}^{T}\bar{A}_2\bar{\nabla}{\bf u}_{i,j,k}\big]_{j=1}^{i=n_2}\\
+h_1h_2\sum_{i=1}^{n_1}\sum_{j=1}^{n_2}\omega_i^{(1)}\omega_j^{(2)}\big[({\bf u}_t)_{i,j,k}^{T}\bar{A}_3\bar{\nabla}{\bf u}_{i,j,k}\big]_{k=1}^{k=n_3},
\end{multline*}
where $\bar{A}_1, \bar{A}_2$ and $\bar{A}_3$ can be found in Appendix.  We firstly impose homogeneous Dirichlet boundary condition,
\begin{equation*}
{\bf u}_{i,j,k} = {\bf 0}
\end{equation*}
to the left and right boundaries ($i = 1,n_1, j = 1,2,\cdots,n_2,k = 1,2,\cdots,n_3$), to the front and back boundaries ($i = 1,2,\cdots,n_1, j = 1,n_2,k = 1,2,\cdots,n_3$) and to the bottom boundaries ($i = 1,2,\cdots,n_1, j = 1,2,\cdots,n_3, k = 1$). Finally, we consider a free-surface condition on the top boundaries ($i = 1,2,\cdots,n_1, j = 1,2,\cdots,n_2, k = n_3$),
\begin{equation*}
\bar{A}_3^f\bar{\nabla} {\bf u}_{i,j,n_3^f}^f = {\bf 0}.
\end{equation*}
Then, we have
\begin{equation}\label{boundary_f}
B_{h_f} ({\bf u}_t^f,{\bf u}^f) = -h_1^fh_2^f\sum_{i = 1}^{n_1^f}\sum_{j=1}^{n_2^f}\omega_i^{(1)}\omega_j^{(2)}({\bf u}_t^f)^T_{i,j,1}\bar{A}_3^f\bar{\nabla}_f{\bf u}^f_{i,j,1},
\end{equation}
and 
\begin{equation}\label{bounary_c}
B_{h_c} ({\bf u}_t^c,{\bf u}^c) = h_1^ch_2^c\sum_{i = 1}^{ n_1^c}\sum_{j=1}^{n_2^c}\omega_i^{(1)}\omega_j^{(2)}({\bf u}_t^f)^T_{i,j,n_3^c}\bar{A}_3^c\bar{\nabla}_c{\bf u}^c_{i,j,n_3^c}.
\end{equation}
Finally, the semi-discrete energy estimate
\begin{multline}\label{semi_energy_1}
\frac{d}{dt}\big[({\bf u}_t^f,\rho^f {\bf u}_t^f)_{h^f} + S_{h^f}({\bf u}^f,{\bf u}^f_t) + ({\bf u}_t^c,\rho^c {\bf u}_t^c)_{h^c} + S_{h^c}({\bf u}^c,{\bf u}^c_t) \big]  = \\
2B_{h^f}({\bf u}_t^f,{\bf u}^f) + 2B_{h^c}({\bf u}_t^c,{\bf u}^c) + 2h_3^f\omega_1^{(3)}h_1^f h_2^f\sum_{i=1}^{n_1^f}\sum_{j=1}^{n_2^f}\omega_i^{(1)}\omega_j^{(2)}({\bf u}_t^f)^T_{i,j,1}{\bm \eta}_{i,j},
\end{multline}
plugging (\ref{boundary_f}) and (\ref{bounary_c}) into (\ref{semi_energy_1}), we have
\begin{multline}\label{semi_energy_2}
\frac{d}{dt}\big[({\bf u}_t^f,\rho^f {\bf u}_t^f)_{h^f} + S_{h^f}({\bf u}^f,{\bf u}^f_t) + ({\bf u}_t^c,\rho^c {\bf u}_t^c)_{h^c} + S_{h^c}({\bf u}^c,{\bf u}^c_t) \big]  = \\
2\Big(-{\bf u}_t^f,\frac{\bar{A}_3^f\bar{\nabla}_f{\bf u}^f}{J^f|\nabla r_f^{(3)}|}\Big)_{h_f,\Gamma} + 2\Big({\bf u}_t^c,\frac{\bar{A}_3^c\bar{\nabla}_c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\Big)_{h_c,\Gamma} + 2\Big({\bf u}_t^f,\frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\Big)_{h_f,\Gamma} = \\
2\Big({\bf u}_t^f,-\frac{\bar{A}_3^f\bar{\nabla}_f{\bf u}^f}{J^f|\nabla r_f^{(3)}|} + \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\Big)_{h_f,\Gamma} +  2\Big({\bf u}_t^c,\frac{\bar{A}_3^c\bar{\nabla}_c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\Big)_{h_c,\Gamma} = \\
2\Big(\mathcal{P}{\bf u}^c_t,-\frac{\bar{A}_3^f\bar{\nabla}_f{\bf u}^f}{J^f|\nabla r_f^{(3)}|} + \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\Big)_{h_f,\Gamma} + 2\Big({\bf u}_t^c,\frac{\bar{A}_3^c\bar{\nabla}_c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\Big)_{h_c,\Gamma} = \\
2\Big({\bf u}_t^c,\mathcal{R}\Big(-\frac{\bar{A}_3^f\bar{\nabla}_f{\bf u}^f}{J^f|\nabla r_f^{(3)}|} + \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\Big)\Big)_{h_c,\Gamma} + 2\Big({\bf u}_t^c,\frac{\bar{A}_3^c\bar{\nabla}_c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\Big)_{h_c,\Gamma} = 0
\end{multline}


\section{The temporal discretization}
We present the predictor-corrector discretization in time, and explain how the ghost points are updated. In addtion, we describle the iterative methods. Perhaps we shall also talk about CFL and the time steps. Maybe no fully-discrete energy analysis? That would be very messy. 


\section{Numerical Experiments}

\subsection{Verification of convergence rate}
Show fourth order convergence

\subsection{Gaussian source}
Show that no reflection at the mesh refinement interfaces. 

If the code is incorporated into SW4, it would be nice to solve a practical problem. 

\subsection{Experiment 3}
We shall have an experiment for energy conservation. We also need to evaluate the iterative methods. These can be Experiment 3, or incoporated in the first two experiments.

\section{Conclusion}
\end{document}
